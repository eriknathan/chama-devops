{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-foreground">Novo Chamado</h1>
        <p class="mt-2 text-sm text-muted-foreground">Descreva detalhadamente o problema ou solicitação.</p>
    </div>

    <div class="bg-card shadow-sm rounded-xl overflow-hidden border border-border p-6">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            {% if form.non_field_errors %}
            <div class="rounded-md bg-destructive/10 p-4">
                <div class="flex">
                    <div class="ml-3">
                        <div class="text-sm text-destructive font-medium">
                            {{ form.non_field_errors.0 }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="space-y-4">
                {% for field in form %}
                <div id="field-container-{{ field.name }}" {% if field.name == 'description' %}
                    class="transition-all duration-300" {% endif %}>
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-foreground mb-1">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                    <p class="text-destructive text-xs italic mt-1">{{ field.errors.0 }}</p>
                    {% endif %}
                </div>
                {% if field.name == 'topic' %}
                <div id="topic-details-container"
                    class="hidden rounded-md bg-muted p-4 text-sm text-muted-foreground border border-border mt-2">
                    <h4 class="font-medium text-foreground mb-2">Detalhes do Tópico:</h4>
                    <div id="topic-details-content" class="whitespace-pre-wrap"></div>
                </div>
                {% endif %}
                {% endfor %}
            </div>



            <div class="flex justify-end gap-3 pt-4">
                <a href="{% url 'ticket-list' %}"
                    class="px-4 py-2 border border-input rounded-lg text-sm font-medium text-muted-foreground hover:bg-muted focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    Cancelar
                </a>
                <button type="submit"
                    class="px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-primary-foreground bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                    Abrir Chamado
                </button>
            </div>
        </form>
    </div>

    <!-- JSON Data for Topic Templates -->
    {{ topic_templates|json_script:"topic-templates-data" }}

    <!-- Script to handle dynamic template building -->
    {% if topic_templates or topic_forms %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const topicSelect = document.getElementById('id_topic');
            const descriptionField = document.getElementById('id_description');

            // Safe parsing of JSON contexts using Django json_script
            const topicTemplatesElement = document.getElementById('topic-templates-data');
            let topicTemplates = {};
            if (topicTemplatesElement) {
                try {
                    topicTemplates = JSON.parse(topicTemplatesElement.textContent);
                    // Handle double-encoded JSON if necessary (views.py uses json.dumps)
                    if (typeof topicTemplates === 'string') {
                        topicTemplates = JSON.parse(topicTemplates);
                    }
                } catch (e) {
                    console.error('Error parsing topic templates:', e);
                }
            }

            if (topicSelect && descriptionField) {
                const detailsContainer = document.getElementById('topic-details-container');
                const detailsContent = document.getElementById('topic-details-content');

                function updateTopicDetails() {
                    const selectedTopicId = topicSelect.value;
                    const templateText = topicTemplates[selectedTopicId];

                    if (templateText && detailsContainer && detailsContent) {
                        // Show details
                        detailsContent.textContent = templateText;
                        detailsContainer.classList.remove('hidden');

                    } else if (detailsContainer) {
                        // Hide details if no template
                        detailsContainer.classList.add('hidden');
                        if (detailsContent) detailsContent.textContent = '';
                    }
                }

                // Attach event listener
                topicSelect.addEventListener('change', updateTopicDetails);

                // Trigger on load in case of pre-selection (e.g. browser back button or form errors)
                updateTopicDetails();
            }
        });
    </script>
    {% endif %}
</div>
{% endblock %}